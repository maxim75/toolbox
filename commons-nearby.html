<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<link href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
		<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
 
		<style>
			/* CSS here */
			img.test {
				width: 50px;
				height: 50px;
			}

			.btn-file {
			    position: relative;
			    overflow: hidden;
			    height: 100px;
			    width: 300px;
			}
			.btn-file input[type=file] {
			    position: absolute;
			    top: 0;
			    right: 0;
			    min-width: 100%;
			    min-height: 100%;
			    font-size: 100px;
			    text-align: right;
			    filter: alpha(opacity=0);
			    opacity: 0;
			    outline: none;
			    background: white;
			    cursor: inherit;
			    display: block;

			}
		</style>
	</head>
 
	<body>
		<span class="btn btn-default btn-file">
    		Browse <input type="file" id="file" name="file" data-bind="event: { change: onFileChange }" />
		</span>

		<ul data-bind="visible: latlng()">
			<li>
				<span data-bind="text: getGeolink('latlon')"></span>
			</li>
			<li>
				<a href="#" data-bind="attr: { href: getGeolink('google') }">Google Map</a>
			</li>
			<li>
				<a href="#" data-bind="attr: { href: getGeolink('commons') }">Commons</a>
			</li>
		</ul>
		

		<div data-bind="visible: categories().length > 0">
			<h3>Categories</h3>
			<ul data-bind="foreach: categories">
			 	<li>
			 		<a href="#" data-bind="attr: { href: getCommonsUrl('Category:'+$data) }">
			 			<span data-bind="text: $data"></span>
			 		</a>
			 	</li>
			</ul>
		</div>

		<div data-bind="visible: fileCategories().length > 0">
			<h3>File Categories</h3>
			<table class="table">
		      <thead>
		        <tr>
		          <th>title</th>
		          <th>count</th>
		        </tr>
		      </thead>
		      <tbody id="exif-table-body" data-bind="foreach: groupArray(fileCategories())">
		      	<tr>
		      		<td>
		      			<a href="#" data-bind="attr: { href: getCommonsUrl(value) }">
		      				<span data-bind="text: value"></span>
		      			</a>
		      		</td>
		      		<td data-bind="text: count"></td>
		      	</tr>
		      </tbody>
		    </table>
	    </div>

	    <div data-bind="visible: contributors().length > 0">
			<h3>Contributors</h3>
			<table class="table">
		      <thead>
		        <tr>
		          <th>title</th>
		          <th>count</th>
		        </tr>
		      </thead>
		      <tbody id="exif-table-body" data-bind="foreach: groupArray(contributors())">
		      	<tr>
		      		<td>
		      			<a href="#" data-bind="attr: { href: 'User:'+getCommonsUrl(value) }">
		      				<span data-bind="text: value"></span>
		      			</a>
		      		</td>
		      		<td data-bind="text: count"></td>
		      	</tr>
		      </tbody>
		    </table>
	    </div>
		 
		<div data-bind="visible: files().length > 0">
			<h3>Files</h3>
			<table class="table">
				<thead>
					<tr>
						<th>dist</th>
						<th>title</th>
					</tr>
				</thead>
				<tbody id="exif-table-body" data-bind="foreach: files">
					<tr>
						<td data-bind="text: dist"></td>
						<td>
							<a href="#" data-bind="attr: { href: getCommonsUrl(title) }">
			      				<span data-bind="text: title"></span>
			      			</a>
						</td>
					</tr>
				</tbody>
			</table>
	    </div>

		 <table class="table">
	      <thead>
	        <tr>
	          <th>Tag name</th>
	          <th>Tag value</th>
	        </tr>
	      </thead>

	      <tbody id="exif-table-body" data-bind="foreach: tags">
	      	<tr>
	      		<td data-bind="text: $data[0]"></td>
	      		<td data-bind="text: $data[1].value"></td>
	      		<td data-bind="text: $data[1].description"></td>
	      	</tr>
	      </tbody>
	    </table>
	</body>
 
	<script src="//cdn.jsdelivr.net/jquery/2.2.1/jquery.min.js"></script>
	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script src="//cdn.jsdelivr.net/underscorejs/1.8.2/underscore-min.js"></script>
	<script src="//cdn.jsdelivr.net/knockout/3.4.0/knockout.js"></script>
	<script src="//cdn.jsdelivr.net/knockout.validation/1.0.2/knockout.validation.min.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

	<script src="https://cdn.rawgit.com/maxim75/geolinks/0.0.11/dist/geolinks.js"></script>
	<script src="jslib/ExifReader.js?2"></script>
	<script>

		var escapeWikimediaName = function(name) {
			return encodeURI(name.replace(" ", "_"));
		};

		var getCommonsUrl = function(name) {
			return "https://commons.wikimedia.org/wiki/" + escapeWikimediaName(name);
		};

		var getNearbyCommonsPhotos = function(lat, lng, radius) {

			var dfd = $.Deferred();

			var params = { 
				format: "json",
				action: "query",
				list: "geosearch",
				gsprimary: "all",
				gsnamespace: "6",
				gsradius: radius,
				gscoord: lat + "|" + lng,
				"gslimit": 100
				//origin: window.location.protocol + "//" + window.location.hostname + ":" + window.location.port
			};

			var url = "https://crossorigin.me/https://commons.wikimedia.org/w/api.php?" + $.param(params);
			$.ajax({ url: url }).done(function(r) {
				dfd.resolve(r.query.geosearch);
			});

			return dfd;
		};

		var getCommonsCategoriesForTitles = function(titles) {

			var dfd = $.Deferred();

			var params = { 

				format: "json",
				action: "query",
				prop: "categories|contributors",
				titles: titles.join("|"),
				//origin: window.location.protocol + "//" + window.location.hostname + ":" + window.location.port
			};

			var url = "https://crossorigin.me/https://commons.wikimedia.org/w/api.php?" + $.param(params);
			$.ajax({ url: url }).done(function(r) {

				var categories = [];
				var contributors = [];

				_(r.query.pages).map(function(x) { _(x.categories).map(function(y) { categories.push(y.title) }) });
				_(r.query.pages).map(function(x) { _(x.contributors).map(function(y) { contributors.push(y.name) }) });

				dfd.resolve({categories: categories, contributors: contributors});
			});

			return dfd;
		};

		var getCommonsCategories = function(lat, lng, limit) {

			var dfd = $.Deferred();

			var params = { 
				q: "claim[373] and around[625," + lat + "," + lng + "," + limit + "]",
				props: "373,625"
			};

			var url = "https://crossorigin.me/http://wdq.wmflabs.org/api?" + $.param(params);
			$.ajax({ url: url }).done(function(r) {
				var result = _(r.props["373"]).map(function(x) { return x[2] });
				dfd.resolve(result);
			});

			return dfd;
		};

		ko.observableArray.fn.pushAll = function(valuesToPush) {
		    var underlyingArray = this();
		    this.valueWillMutate();
		    ko.utils.arrayPushAll(underlyingArray, valuesToPush);
		    this.valueHasMutated();
		    return this;  //optional
		};

		var Vm = function() {
			var self = this;
 
			self.tags = ko.observableArray();
			self.categories = ko.observableArray();
			self.contributors = ko.observableArray();
			self.fileCategories = ko.observableArray();
			self.files = ko.observableArray();
			self.latlng = ko.observable();

			self.getGeolink = function(id) {
				return ko.computed(function() {
					if(!self.latlng()) return null;
					return geolink.getLink(id, {lat: self.latlng().lat, lng:  self.latlng().lng, zoom: 17} );
				});
			};



			self.chunk = function (array, chunkSize) {
		        // http://stackoverflow.com/questions/8495687/split-array-into-chunks
		        var R = [];
		        for (var i = 0; i < array.length; i += chunkSize)
		            R.push(array.slice(i, i + chunkSize));
		        return R;
		    };

			self.readFile = function(file) {

				exif = new ExifReader();
				exif.load(file);
				exif.deleteTag('MakerNote');

				// Output the tags on the page.
				tags = exif.getAllTags();
				return tags;

			};

			self.onFileChange = function(vm, e) {

				var files, reader;

		    	files = event.target.files;
		    	reader = new FileReader();

		    	reader.onload = function (event) {

			    	var tags = self.readFile(event.target.result);
			    	self.tags(_.pairs(tags));


			    	self.latlng({ 
			    		lat: tags["GPSLatitude"].description * (tags["GPSLatitudeRef"].value == "S" ? -1 : 1),
			    		lng: tags["GPSLongitude"].description * (tags["GPSLongitudeRef"].value == "W" ? -1 : 1)
			    	});
			    };

			    // We only need the start of the file for the Exif info.
			    reader.readAsArrayBuffer(files[0].slice(0, 128 * 1024));
			};

			self.groupArray = function(arr) {
				return _(arr)
					.chain()
					.countBy()
					.map(function(value, key) { return { value: key, count: value  }; })
					.sortBy(function(x) { return -x.count })
					.value();
			};
			

			self.latlng.subscribe(function() {

				self.fileCategories.removeAll();
				self.contributors.removeAll();

				getCommonsCategories(self.latlng().lat, self.latlng().lng, 3).done(function(categories) {
					self.categories(categories);
				});

				getNearbyCommonsPhotos(self.latlng().lat, self.latlng().lng, 2000).done(function(files) {
					self.files(files);


					var fileNames = _(files).map(function(x) { return x.title; });

					var fileNameChunks = self.chunk(fileNames, 30);

					_(fileNameChunks).map(function(fileNameChunk) {

						getCommonsCategoriesForTitles(fileNameChunk).done(function(r){

							self.fileCategories.pushAll(r.categories);
							self.contributors.pushAll(r.contributors);
						});
					});

					
				});
			});
		};

		var vm = new Vm();
		ko.applyBindings(vm, $("body")[0]);
	</script>
</html>