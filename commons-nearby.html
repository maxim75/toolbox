<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<link href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
		<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" rel="stylesheet" type="text/css" />
 
		<style>
			/* CSS here */
			img.test {
				width: 50px;
				height: 50px;
			}

			.btn-file {
			    position: relative;
			    overflow: hidden;
			    height: 100px;
			    width: 300px;
			}
			.btn-file input[type=file] {
			    position: absolute;
			    top: 0;
			    right: 0;
			    min-width: 100%;
			    min-height: 100%;
			    font-size: 100px;
			    text-align: right;
			    filter: alpha(opacity=0);
			    opacity: 0;
			    outline: none;
			    background: white;
			    cursor: inherit;
			    display: block;

			}

			#map {
				width: 500px;
				height: 500px;
				border: solid 1px #999;
			}
		</style>
	</head>
 
	<body>
		<div data-bind="visible: false"> 
			Loading...
		</div>
		<div style="display: none" data-bind="visible: true"> 

			<span class="btn btn-default btn-file">
	    		<span>Drag & drop image file or click to select file</span>
	    		<input type="file" id="file" name="file" data-bind="event: { change: onFileChange }" />
			</span>

			<ul data-bind="visible: latlng(), foreach: [ 'latlon' ]">
				<li>
					<span data-bind="text: $parent.getGeolink($data)"></span>
				</li>
			</ul>

			<ul data-bind="visible: latlng(), foreach: ['google', 'commons' ]">
				<li>
					<a href="#" data-bind="attr: { href: $parent.getGeolink($data) }">
						<span data-bind="text: $data"></span>
					</a>
				</li>
			</ul>

			<div id="map"></div>

			<!-- ko if: reverseGeocode() -->
			<h3>Reverse Geocode</h3>
			<table class="table">
				<thead>
					<tr>
						<th>Tag name</th>
						<th>Tag value</th>
					</tr>
				</thead>

				<tbody id="exif-table-body" data-bind="foreach: reverseGeocode().features">
					<tr>
						<td data-bind="text: $data.properties.name"></td>
						<td data-bind="text: $data.properties.distance"></td>
						<td data-bind="text: $data.properties.label"></td>
						<td data-bind="text: $data.properties.gid"></td>
					</tr>
				</tbody>
			</table>
			<p>
				<a href="https://search.mapzen.com/v1/attribution">Geocoding by Pelias from Mapzen</a> 
			</p>

			<p>Data from:
				<ul>
					<li>OpenStreetMap OpenStreetMap contributors under ODbL</li>
					<li>OpenAddresses under a Creative Commons Zero public domain designation</li>
					<li>Quattroshapes under CC-BY-2.0</li>
					<li>GeoNames under CC-BY-3.0</li>
				</ul>
			</p>
			<!-- /ko -->

			<div data-bind="visible: categories().length > 0">
				<h3>Categories</h3>
				<ul data-bind="foreach: categories">
				 	<li>
				 		<a href="#" data-bind="attr: { href: getCommonsUrl('Category:'+$data) }">
				 			<span data-bind="text: $data"></span>
				 		</a>
				 	</li>
				</ul>
			</div>

			<div data-bind="visible: fileCategories().length > 0">
				<h3>File Categories</h3>
				<table class="table">
			      <thead>
			        <tr>
			          <th>title</th>
			          <th>count</th>
			        </tr>
			      </thead>
			      <tbody id="exif-table-body" data-bind="foreach: groupArray(fileCategories())">
			      	<tr>
			      		<td>
			      			<a href="#" data-bind="attr: { href: getCommonsUrl(value) }">
			      				<span data-bind="text: value"></span>
			      			</a>
			      		</td>
			      		<td data-bind="text: count"></td>
			      	</tr>
			      </tbody>
			    </table>
		    </div>

		    <div data-bind="visible: contributors().length > 0">
				<h3>Contributors</h3>
				<table class="table">
			      <thead>
			        <tr>
			          <th>title</th>
			          <th>count</th>
			        </tr>
			      </thead>
			      <tbody id="exif-table-body" data-bind="foreach: groupArray(contributors())">
			      	<tr>
			      		<td>
			      			<a href="#" data-bind="attr: { href: getCommonsUrl('User:'+value) }">
			      				<span data-bind="text: value"></span>
			      			</a>
			      		</td>
			      		<td data-bind="text: count"></td>
			      	</tr>
			      </tbody>
			    </table>
		    </div>
			 
			<div data-bind="visible: files().length > 0">
				<h3>Files</h3>
				<table class="table">
					<thead>
						<tr>
							<th>dist</th>
							<th>title</th>
							<th>categories</th>
						</tr>
					</thead>
					<tbody id="exif-table-body" data-bind="foreach: files">
						<tr>
							<td data-bind="text: dist"></td>
							<td>
								<a href="#" data-bind="attr: { href: getCommonsUrl(title) }">
				      				<span data-bind="text: title"></span>
				      			</a>

							</td>
							<td data-bind="foreach: $root.listCategories($data.title)">
								<div>
									<a href="#" data-bind="text: $data, attr: { href: getCommonsUrl($data) }"></a>
								</div>
							</td>
							<td data-bind="foreach: $root.listContributors($data.title)">
								<div>
									<a href="#" data-bind="text: $data, attr: { href: getCommonsUrl('User:'+$data) }"></a>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
		    </div>

		    <div data-bind="visible: tags().length > 0">
			    <h3>EXIF data</h3>
				<table class="table">
					<thead>
						<tr>
							<th>Tag name</th>
							<th>Tag value</th>
						</tr>
					</thead>

					<tbody id="exif-table-body" data-bind="foreach: tags">
						<tr>
							<td data-bind="text: $data[0]"></td>
							<td data-bind="text: $data[1].value"></td>
							<td data-bind="text: $data[1].description"></td>
						</tr>
					</tbody>
				</table>
		    </div>
		</div>
	</body>
 
	<script src="//cdn.jsdelivr.net/jquery/2.2.1/jquery.min.js"></script>
	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script src="//cdn.jsdelivr.net/underscorejs/1.8.2/underscore-min.js"></script>
	<script src="//cdn.jsdelivr.net/knockout/3.4.0/knockout.js"></script>
	<script src="//cdn.jsdelivr.net/knockout.validation/1.0.2/knockout.validation.min.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

	<script src="https://cdn.rawgit.com/maxim75/geolinks/0.0.11/dist/geolinks.js"></script>
	<script src="jslib/ExifReader.js?2"></script>
	<script>

		var reverseGeocode = function(lat, lng, apiKey) {

			var dfd = $.Deferred();

			var params = {
				"api_key": apiKey,
				"point.lat": lat, 
				"point.lon": lng
			};

			$.ajax("https://search.mapzen.com/v1/reverse?" + $.param(params))
			.done(function(response) {

				//console.log("F", response.features);
				dfd.resolve(response);
			});

			return dfd; 
		};

		var escapeWikimediaName = function(name) {
			return encodeURI(name.replace(" ", "_"));
		};

		var getCommonsUrl = function(name) {
			return "https://commons.wikimedia.org/wiki/" + escapeWikimediaName(name);
		};

		var getNearbyCommonsPhotos = function(lat, lng, radius) {

			var dfd = $.Deferred();

			var params = { 
				format: "json",
				action: "query",
				list: "geosearch",
				gsprimary: "all",
				gsnamespace: "6",
				gsradius: radius,
				gscoord: lat + "|" + lng,
				gslimit: 100
			};

			var url = "https://commons.wikimedia.org/w/api.php?" + $.param(params);
			$.ajax({ 
				url: url,
				jsonp: "callback",
				dataType: "jsonp"

			}).done(function(r) {
				dfd.resolve(r.query.geosearch);
			});

			return dfd;
		};

		var getCommonsCategoriesForTitles = function(titles) {

			var dfd = $.Deferred();

			var params = { 
				format: "json",
				action: "query",
				prop: "categories|contributors",
				titles: titles.join("|")	
			};

			var url = "https://commons.wikimedia.org/w/api.php?" + $.param(params);
			$.ajax({ 
				url: url,
				jsonp: "callback",
				dataType: "jsonp"
			}).done(function(r) {

				var categories = [];
				var contributors = [];
				var pages = {};

				_(r.query.pages).map(function(x) { _(x.categories).map(function(y) { categories.push(y.title) }) });
				_(r.query.pages).map(function(x) { _(x.contributors).map(function(y) { contributors.push(y.name) }) });

				_(r.query.pages).map(function(x, pageId) { 
					pages[x.title] = {
						categories: _(x.categories).map(function(y) { return y.title; }),
						contributors: _(x.contributors).map(function(y) { return y.name; }),
					};
				});

				dfd.resolve({categories: categories, contributors: contributors, pages: pages });
			});

			return dfd;
		};

		var getCommonsCategories = function(lat, lng, limit) {

			var dfd = $.Deferred();

			var params = { 
				q: "claim[373] and around[625," + lat + "," + lng + "," + limit + "]",
				props: "373,625"
			};

			var url = "http://wdq.wmflabs.org/api?" + $.param(params);
			$.ajax({ 
				url: url,
				jsonp: "callback",
				dataType: "jsonp"
			}).done(function(r) {
				var result = _(r.props["373"]).map(function(x) { return x[2] });
				dfd.resolve(result);
			});

			return dfd;
		};

		ko.observableArray.fn.pushAll = function(valuesToPush) {
		    var underlyingArray = this();
		    this.valueWillMutate();
		    ko.utils.arrayPushAll(underlyingArray, valuesToPush);
		    this.valueHasMutated();
		    return this;  //optional
		};

		var Vm = function() {
			var self = this;
 
 			self.reverseGeocode = ko.observable();
			self.tags = ko.observableArray();
			self.categories = ko.observableArray();
			self.contributors = ko.observableArray();
			self.fileCategories = ko.observableArray();
			self.files = ko.observableArray();
			self.fileProperties = ko.observable();
			self.latlng = ko.observable();
			self.map = L.map('map');

			L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(self.map);


			self.getGeolink = function(id) {
				return ko.computed(function() {
					if(!self.latlng()) return null;
					return geolink.getLink(id, {lat: self.latlng().lat, lng:  self.latlng().lng, zoom: 17} );
				});
			};

			self.chunk = function (array, chunkSize) {
		        // http://stackoverflow.com/questions/8495687/split-array-into-chunks
		        var R = [];
		        for (var i = 0; i < array.length; i += chunkSize)
		            R.push(array.slice(i, i + chunkSize));
		        return R;
		    };

			self.readFile = function(file) {

				exif = new ExifReader();
				exif.load(file);
				exif.deleteTag('MakerNote');

				// Output the tags on the page.
				tags = exif.getAllTags();
				return tags;

			};

			self.onFileChange = function(vm, e) {

				var files, reader;

		    	files = event.target.files;
		    	reader = new FileReader();

		    	reader.onload = function (event) {

			    	var tags = self.readFile(event.target.result);
			    	self.tags(_.pairs(tags));

			    	if(tags["GPSLatitude"] && tags["GPSLongitude"]) {
			    		self.latlng({ 
				    		lat: tags["GPSLatitude"].description * (tags["GPSLatitudeRef"].value == "S" ? -1 : 1),
				    		lng: tags["GPSLongitude"].description * (tags["GPSLongitudeRef"].value == "W" ? -1 : 1)
				    	});
			    	}
			    	else
			    	{
			    		self.latlng(null);
			    	}
			    };

			    // We only need the start of the file for the Exif info.
			    reader.readAsArrayBuffer(files[0].slice(0, 128 * 1024));
			};

			self.groupArray = function(arr) {
				return _(arr)
					.chain()
					.countBy()
					.map(function(value, key) { return { value: key, count: value  }; })
					.sortBy(function(x) { return -x.count })
					.value();
			};
			
			self.listCategories = function(title) {

				return self.fileProperties()[title] 
					? self.fileProperties()[title]['categories']
					: [];
			};

			self.listContributors = function(title) {

				return self.fileProperties()[title] 
					? self.fileProperties()[title]['contributors']
					: [];
			};

			self.getReverseGeocode = function() {
				reverseGeocode(self.latlng().lat, self.latlng().lng, "search-TFuxM-I")
				.done(function(response) {
					self.reverseGeocode(response);
				});
			};

			self.showMap = function() {

				var pos = [self.latlng().lat, self.latlng().lng];
				var map = self.map.setView(pos, 16);

				
				L.marker(pos).addTo(self.map);//.bindPopup("here").openPopup();
			};

			self.latlng.subscribe(function() {

				self.fileProperties({});
				self.fileCategories.removeAll();
				self.contributors.removeAll();
				self.reverseGeocode(null);

				if(!self.latlng()) return;

				self.showMap();

				self.getReverseGeocode();

				getCommonsCategories(self.latlng().lat, self.latlng().lng, 3).done(function(categories) {
					self.categories(categories);
				});

				getNearbyCommonsPhotos(self.latlng().lat, self.latlng().lng, 2000).done(function(files) {
					self.files(files);


					var fileNames = _(files).map(function(x) { return x.title; });

					var fileNameChunks = self.chunk(fileNames, 1);

					_(fileNameChunks).map(function(fileNameChunk) {

						getCommonsCategoriesForTitles(fileNameChunk).done(function(r){

							self.fileCategories.pushAll(r.categories);
							self.contributors.pushAll(r.contributors);

							_(r.pages).map(function(x, y) {
								self.fileProperties()[y] = x;
							});
							
							self.fileProperties.notifySubscribers();
						});
					});
				});
			});
		};

		var vm = new Vm();
		ko.applyBindings(vm, $("body")[0]);
	</script>
</html>